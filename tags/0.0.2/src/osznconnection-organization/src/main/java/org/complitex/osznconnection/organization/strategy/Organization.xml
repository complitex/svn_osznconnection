<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.osznconnection.organization.strategy.Organization">

    <resultMap id="Organization" type="DomainObject">
        <id column="object_id" property="id"/>
        <id column="start_date" property="startDate"/>
        <result column="entity_id" property="entityId"/>
        <result column="end_date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_entity_id" property="parentEntityId"/>
        <result column="entity_type_id" property="entityTypeId"/>
    </resultMap>

    <resultMap id="District" type="Attribute">
        <id column="attribute_id" property="attributeId"/>
        <id column="object_id" property="objectId"/>
        <id column="attribute_type_id" property="attributeTypeId"/>
        <id column="start_date" property="startDate"/>
        <result column="status" property="status"/>
        <result column="end_date" property="endDate"/>
        <result column="value_id" property="valueId"/>
        <result column="value_type_id" property="valueTypeId"/>
    </resultMap>

    <select id="loadSimpleAttributes" parameterType="DomainObjectExample" resultMap="org.complitex.dictionaryfw.entity.Attribute.Attribute">
        SELECT attr.`attribute_id`, attr.`object_id`, attr.`attribute_type_id`, attr.`value_id`, attr.`value_type_id`, attr.`start_date`, attr.`end_date`,
        attr.`status`, '${table}' as table_name
        FROM `organization_attribute` attr WHERE attr.`object_id` = #{id} AND attr.`status` = 'ACTIVE'
        AND ((attr.`attribute_type_id` IN (900, 901)) OR (attr.`attribute_type_id` <![CDATA[ >= ]]> 903))
    </select>

    <select id="findById" resultMap="org.complitex.osznconnection.organization.strategy.Organization.Organization" parameterType="DomainObjectExample">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        (SELECT ent.`entity_table` FROM `entity` ent WHERE ent.`id` = e.`parent_entity_id`) as parent_entity,
        e.`parent_entity_id`, e.`entity_type_id`, '${table}' as table_name
        FROM `${table}` e WHERE (e.`status` = 'ACTIVE' OR e.`status` = 'INACTIVE') AND e.`object_id` = #{id}
    </select>

    <select id="loadComplexAttributes" resultMap="org.complitex.osznconnection.organization.strategy.Organization.District" parameterType="DomainObjectExample">
        SELECT attr.`attribute_id`, attr.`object_id`, attr.`attribute_type_id`, attr.`value_id`, attr.`value_type_id`, attr.`start_date`, attr.`end_date`,
        attr.`status`
        FROM `organization_attribute` attr WHERE attr.`object_id` = #{id} AND attr.`status` = 'ACTIVE' AND attr.`attribute_type_id` = 902
    </select>

</mapper>
