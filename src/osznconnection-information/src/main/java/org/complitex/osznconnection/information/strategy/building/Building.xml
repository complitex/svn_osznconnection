<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.osznconnection.information.strategy.building.Building">

    <resultMap id="Building" type="org.complitex.osznconnection.information.strategy.building.entity.Building">
        <id column="object_id" property="id"/>
        <id column="start_date" property="startDate"/>
        <result column="entity_id" property="entityId"/>
        <result column="end_date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_entity_id" property="parentEntityId"/>
        <result column="parent_entity" property="parentEntity"/>
        <result column="entity_type_id" property="entityTypeId"/>
        <!--<collection ofType="Attribute" property="attributes" column="{table = table_name, id = object_id, startDate = start_date}"
                    select="org.complitex.dictionaryfw.entity.Attribute.find"/>-->
    </resultMap>

    <resultMap id="HistoryBuilding" type="org.complitex.osznconnection.information.strategy.building.entity.Building">
        <id column="object_id" property="id"/>
        <id column="start_date" property="startDate"/>
        <result column="entity_id" property="entityId"/>
        <result column="end_date" property="endDate"/>
        <result column="status" property="status"/>
        <result column="parent_id" property="parentId"/>
        <result column="parent_entity_id" property="parentEntityId"/>
        <result column="parent_entity" property="parentEntity"/>
        <result column="entity_type_id" property="entityTypeId"/>
    </resultMap>

    <!--<resultMap id="StreetOrDistrict" type="Attribute">
        <id column="attribute_id" property="attributeId"/>
        <id column="object_id" property="objectId"/>
        <id column="attribute_type_id" property="attributeTypeId"/>
        <id column="start_date" property="startDate"/>
        <result column="status" property="status"/>
        <result column="end_date" property="endDate"/>
        <result column="value_id" property="valueId"/>
        <result column="value_type_id" property="valueTypeId"/>
    </resultMap>-->

    <!--<select id="loadSimpleAttributes" parameterType="DomainObjectExample" resultMap="org.complitex.dictionaryfw.entity.Attribute.Attribute">
        SELECT attr.`attribute_id`, attr.`object_id`, attr.`attribute_type_id`, attr.`value_id`, attr.`value_type_id`, attr.`start_date`, attr.`end_date`,
        attr.`status`, '${table}' as table_name
        FROM `building_attribute` attr WHERE attr.`object_id` = #{id} AND attr.`status` = 'ACTIVE'
        AND ((attr.`attribute_type_id` IN (500, 501, 502)) OR (attr.`attribute_type_id` <![CDATA[ >= ]]> 505))
        <foreach item="attrExample" collection="attributeExamples">
            <if test="attrExample.value != null">
                <if test="attrExample.attributeTypeId == 503 or attrExample.attributeTypeId == 504">
                    AND EXISTS(SELECT 1 FROM `building_attribute` ba WHERE ba.`object_id` = attr.`object_id`
                    AND ba.`status` = 'ACTIVE' AND ba.`value_id` = #{attrExample.value}
                    AND ba.`attribute_type_id` = #{attrExample.attributeTypeId} AND ba.`attribute_id` = attr.`attribute_id`)
                </if>
            </if>
        </foreach>
    </select>-->



    <!--<sql id="orderBy">
        <choose>
            <when test="additionalParams != null and additionalParams['orderByAttribute'] != null">
                <choose>
                    <when test="additionalParams['orderByAttribute'] == 'number' ">
                        ORDER BY (SELECT sc.`value` FROM `building_address_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` =
                                (SELECT attr.`value_id` FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`attribute_type_id` = 1500))
                    </when>
                    <when test="additionalParams['orderByAttribute'] == 'corp' ">
                        ORDER BY (SELECT sc.`value` FROM `building_address_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` =
                                (SELECT attr.`value_id` FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`attribute_type_id` = 1501))
                    </when>
                    <when test="additionalParams['orderByAttribute'] == 'structure' ">
                        ORDER BY (SELECT sc.`value` FROM `building_address_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` =
                                (SELECT attr.`value_id` FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`attribute_type_id` = 1502))
                    </when>
                </choose>
                <choose>
                    <when test="asc">
                        ASC
                    </when>
                    <otherwise>
                        DESC
                    </otherwise>
                </choose>
            </when>
            <otherwise>
                <if test="orderByExpression != null">
                    ORDER BY  ${orderByExpression}
                    <choose>
                        <when test="asc">
                            ASC
                        </when>
                        <otherwise>
                            DESC
                        </otherwise>
                    </choose>
                </if>
            </otherwise>
        </choose>

    </sql>-->

    <!--<sql id="from">
        FROM `building` e
        JOIN `building_address` addr ON ((e.`parent_id` = addr.`object_id` OR
            EXISTS(SELECT 1 FROM `building_attribute` ba WHERE ba.`status` = 'ACTIVE' AND ba.`object_id` = e.`object_id` AND ba.`attribute_type_id` = 501
             AND ba.`value_id` = addr.`object_id`))
            AND (addr.`status` = 'ACTIVE' OR addr.`status` = 'INACTIVE'))
    </sql>-->

    <select id="find2" resultMap="org.complitex.osznconnection.information.strategy.building.Building.Building" parameterType="DomainObjectExample">
        SELECT DISTINCT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        e.`parent_entity_id`, e.`entity_type_id`, '${locale}' as locale, '${table}' as table_name
        FROM `building` e WHERE
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.statusFilter"/>
        AND (e.`parent_id` = #{additionalParams.buildingAddressId} OR EXISTS
            (SELECT 1 FROM `building_attribute` ba WHERE ba.`object_id` = e.`object_id` AND ba.`status` = 'ACTIVE' AND ba.`attribute_type_id` = 501
                AND ba.`value_id` = #{additionalParams.buildingAddressId}
            )
            )
    </select>

    <!--<select id="find" resultMap="org.complitex.osznconnection.information.strategy.building.Building.Building" parameterType="DomainObjectExample">
        SELECT DISTINCT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        e.`parent_entity_id`, e.`entity_type_id`, '${locale}' as locale, '${table}' as table_name
        <include refid="org.complitex.osznconnection.information.strategy.building.Building.from"/>
        WHERE
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.osznconnection.information.strategy.building.Building.filter"/>
        <include refid="org.complitex.osznconnection.information.strategy.building.Building.orderBy"/>
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.limit"/>
    </select>

    <sql id="filter">
        <choose>
            <when test="id != null">
                AND e.`object_id` = #{id}
            </when>
            <otherwise>
                    <if test="additionalParams != null">
                        <if test="additionalParams['number'] != null">
                            AND EXISTS(SELECT 1 FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value`
                                <choose>
                                    <when test="comparisonType == 'LIKE'">
                                        LIKE CONCAT('%', #{additionalParams.number}, '%')
                                    </when>
                                    <when test="comparisonType == 'EQUALITY'">
                                        = #{additionalParams.number}
                                    </when>
                                </choose>
                                )
                                AND attr.`attribute_type_id` = 1500)
                        </if>
                        <if test="additionalParams['corp'] != null">
                            AND EXISTS(SELECT 1 FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value`
                                <choose>
                                    <when test="comparisonType == 'LIKE'">
                                        LIKE CONCAT('%', #{additionalParams.corp}, '%')
                                    </when>
                                    <when test="comparisonType == 'EQUALITY'">
                                        = #{additionalParams.corp}
                                    </when>
                                </choose>
                                )
                                AND attr.`attribute_type_id` = 1501)
                        </if>
                        <if test="additionalParams['structure'] != null">
                            AND EXISTS(SELECT 1 FROM `building_address_attribute` attr WHERE attr.`object_id` = addr.`object_id`
                                AND attr.`status` = 'ACTIVE'
                                AND attr.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value`
                                <choose>
                                    <when test="comparisonType == 'LIKE'">
                                        LIKE CONCAT('%', #{additionalParams.structure}, '%')
                                    </when>
                                    <when test="comparisonType == 'EQUALITY'">
                                        = #{additionalParams.structure}
                                    </when>
                                </choose>
                                )
                                AND attr.`attribute_type_id` = 1502)
                        </if>
                        <if test="additionalParams['street'] != null">
                            AND addr.`parent_id` = #{additionalParams.street} AND addr.`parent_entity_id` = 300
                        </if>
                        <if test="additionalParams['city'] != null">
                            AND addr.`parent_id` = #{additionalParams.city} AND addr.`parent_entity_id` = 400
                        </if>
                    </if>
            </otherwise>
        </choose>
    </sql>-->

    <!--<select id="count" resultType="integer" parameterType="DomainObjectExample">
        SELECT COUNT(*)
        <include refid="org.complitex.osznconnection.information.strategy.building.Building.from"/>
        WHERE
        <include refid="org.complitex.dictionaryfw.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.osznconnection.information.strategy.building.Building.filter"/>
    </select>-->

    <!--<select id="findStreetInSearchComponent" parameterType="long" resultType="long">
        SELECT ba.`parent_id` FROM `building_address` ba WHERE (ba.`status` = 'ACTIVE' OR ba.`status` = 'INACTIVE')
            AND ba.`object_id` = (SELECT b.`parent_id` FROM `building` b WHERE b.`object_id` = #{id}) AND ba.`parent_entity_id` = 300
        
        SELECT attr.`value_id` FROM `building_attribute` attr WHERE attr.`status` = 'ACTIVE' AND attr.`object_id` = #{id} AND attr.`attribute_type_id` = 503 limit 0,1
    </select>-->

    <select id="findById" resultMap="org.complitex.osznconnection.information.strategy.building.Building.Building" parameterType="DomainObjectExample">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        (SELECT ent.`entity_table` FROM `entity` ent WHERE ent.`id` = e.`parent_entity_id`) as parent_entity,
        e.`parent_entity_id`, e.`entity_type_id`, '${table}' as table_name
        FROM `${table}` e WHERE (e.`status` = 'ACTIVE' OR e.`status` = 'INACTIVE') AND e.`object_id` = #{id}
    </select>

    <select id="checkBuildingAddress" parameterType="hashmap" resultType="long">
        SELECT DISTINCT b.`object_id` FROM `building` b
            JOIN `building_address` addr ON (((b.`parent_id` = addr.`object_id`) OR
            EXISTS(SELECT 1 FROM `building_attribute` ba WHERE ba.`object_id` = b.`object_id` AND ba.`status` = 'ACTIVE' AND ba.`attribute_type_id` = 501
            AND ba.`value_id` = addr.`object_id`)) AND (addr.`status` = 'ACTIVE' OR addr.`status` = 'INACTIVE'))
            JOIN `building_address_attribute` num ON (num.`object_id` = addr.`object_id` AND num.`status` = 'ACTIVE' AND num.`attribute_type_id` = 1500)
            LEFT JOIN `building_address_attribute` corp ON (corp.`object_id` = addr.`object_id` AND corp.`status` = 'ACTIVE' AND corp.`attribute_type_id` = 1501)
            LEFT JOIN `building_address_attribute` struc ON (struc.`object_id` = addr.`object_id` AND struc.`status` = 'ACTIVE' AND struc.`attribute_type_id` = 1502)
        WHERE (b.`status` = 'ACTIVE' OR b.`status` = 'INACTIVE') AND
        num.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value` = #{number} AND sc.`locale` = #{locale}) AND
            <choose>
                <when test="corp == null">
                    corp.`value_id` IS NULL
                </when>
                <otherwise>
                    corp.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value` = #{corp} AND sc.`locale` = #{locale})
                </otherwise>
            </choose>
            AND
            <choose>
                <when test="structure == null">
                    struc.`value_id` IS NULL
                </when>
                <otherwise>
                    struc.`value_id` IN (SELECT sc.`id` FROM `building_address_string_culture` sc WHERE sc.`value` = #{structure} AND sc.`locale` = #{locale})
                </otherwise>
            </choose>
            AND
            addr.`parent_entity_id` = #{parentEntityId} AND addr.`parent_id` = #{parentId}
    </select>

    <!--<select id="loadComplexAttributes" resultMap="org.complitex.osznconnection.information.strategy.building.Building.StreetOrDistrict" parameterType="DomainObjectExample">
        SELECT attr.`attribute_id`, attr.`object_id`, attr.`attribute_type_id`, attr.`value_id`, attr.`value_type_id`, attr.`start_date`, attr.`end_date`,
        attr.`status`
        FROM `building_attribute` attr WHERE attr.`object_id` = #{id} AND attr.`status` = 'ACTIVE' AND attr.`attribute_type_id` IN (503, 504)
    </select>-->

    <!-- history -->

    <!--<select id="historyDates" resultType="date" parameterType="DomainObjectExample">
        SELECT e.`start_date` FROM `${table}` e WHERE e.`object_id`= #{id}
        UNION
        SELECT e.`end_date` FROM `${table}` e WHERE e.`object_id`= #{id}
        UNION
        SELECT aa.`start_date` FROM `${table}_attribute` aa WHERE aa.`object_id`= #{id}
        UNION
        SELECT aa.`end_date` FROM `${table}_attribute` aa WHERE aa.`object_id`= #{id}
    </select>-->

    <select id="findBuildingAddresses" parameterType="long" resultType="long">
        SELECT addr.`object_id` FROM `building_address` addr WHERE addr.`object_id` IN
            (SELECT b.`parent_id` FROM `building` b WHERE b.`object_id` = #{buildingId})
        UNION
        SELECT addr.`object_id` FROM `building_address` addr WHERE
            EXISTS(SELECT 1 FROM `building_attribute` ba WHERE ba.`object_id` = #{buildingId} AND ba.`attribute_type_id` = 501 AND ba.`value_id` = addr.`object_id`)
    </select>

    <select id="findHistoryObject" parameterType="DomainObjectExample" resultMap="HistoryBuilding">
        SELECT e.`object_id`, e.`start_date`, e.`end_date`, e.`status`, e.`parent_id`,
        (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{table}) as entity_id,
        (SELECT ent.`entity_table` FROM `entity` ent WHERE ent.`id` = e.`parent_entity_id`) as parent_entity,
        e.`parent_entity_id`, e.`entity_type_id`, '${table}' as table_name
        FROM `${table}` e WHERE e.`object_id` = #{id}
        AND e.`start_date` = (SELECT MAX(e1.`start_date`) FROM `${table}` e1 WHERE e1.`object_id` = #{id} AND e1.`start_date`
        <![CDATA[ <= ]]>
        #{startDate})
    </select>

</mapper>
