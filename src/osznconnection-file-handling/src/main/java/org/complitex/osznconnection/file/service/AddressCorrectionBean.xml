<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.AddressCorrectionBean">

    <select id="findInternalObject" resultType="long" parameterType="hashmap">
        SELECT c.`${entity}_id` FROM `${entity}_correction` c WHERE c.`organization_id` = #{organizationId} AND 
        TO_CYRILLIC(c.`${entity}`) = TO_CYRILLIC(#{_value})
        <if test="parentId != null">
            AND EXISTS(SELECT 1 FROM `${entity}` e WHERE e.`id` = c.`${entity}_id` AND e.`status` = 'ACTIVE' AND e.`parent_id` = #{parentId})
        </if>
        LIMIT 0,1
    </select>

    <select id="findInternalBuilding" resultType="long" parameterType="hashmap">
        SELECT c.`building_id` FROM `building_correction` c WHERE c.`organization_id` = #{organizationId} AND 
        TO_CYRILLIC(c.`building_num`) = TO_CYRILLIC(#{buildingNumber})
        <choose>
            <when test="buildingCorp == null">
                AND c.`building_corp` IS NULL
            </when>
            <otherwise>
                 AND TO_CYRILLIC(c.`building_corp`) = TO_CYRILLIC(#{buildingCorp})
            </otherwise>
        </choose>
        <if test="parentId != null">
            AND EXISTS(SELECT 1 FROM `building` e WHERE e.`id` = c.`building_id` AND e.`status` = 'ACTIVE' AND e.`parent_id` = #{parentId})
        </if>
        LIMIT 0,1
    </select>

    <select id="findInternalObjectType" resultType="long" parameterType="hashmap">
        SELECT etc.`entity_type_id` typeId
        FROM `entity_type_correction` etc
        WHERE etc.`organization_id` = #{organizationId}
        AND EXISTS(SELECT 1 FROM `entity_type` et WHERE et.`id` = etc.`entity_type_id` AND et.`end_date` IS NULL)
        LIMIT 0,1
    </select>

    <insert id="insert" parameterType="hashmap">
        INSERT INTO `${entity}_correction`(`organization_id`, `${entity}`, `${entity}_id`) VALUES
        (#{organizationId}, UPPER(TO_CYRILLIC(#{_value})), #{objectId})
    </insert>

    <insert id="insertBuilding" parameterType="hashmap">
        INSERT INTO `building_correction`(`organization_id`, `building_num`, `building_corp`, `building_id`) VALUES
        (#{organizationId}, UPPER(TO_CYRILLIC(#{buildingNumber})), UPPER(TO_CYRILLIC(#{buildingCorp})), #{objectId})
    </insert>

    <select id="findOutgoingObject" resultType="hashmap" parameterType="hashmap">
        SELECT c.`${entity}` stringValue, c.`organization_${entity}_code` codeValue FROM `${entity}_correction` c
        WHERE c.`organization_id` = #{calculationCenterId}
        AND c.`${entity}_id` = #{objectId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingBuilding" resultType="hashmap" parameterType="hashmap">
        SELECT c.`building_num` buildingNumber, c.`building_corp` buildingCorp, c.`organization_building_code` codeValue FROM `building_correction` c
        WHERE c.`organization_id` = #{calculationCenterId}
        AND c.`building_id` = #{objectId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingObjectType" resultType="hashmap" parameterType="hashmap">
        SELECT etc.`type` type, etc.`organization_type_code` typeCode
        FROM `entity_type_correction` etc
        WHERE etc.`organization_id` = #{calculationCenterId}
        AND etc.`entity_type_id` = #{entityTypeId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingDistrict" resultType="hashmap" parameterType="long">
        SELECT c.`district` stringValue, c.`organization_district_code` codeValue FROM `district_correction` c
        WHERE c.`organization_id` = #{calculationCenterId}
        LIMIT 0,1
    </select>

</mapper>