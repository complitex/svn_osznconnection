<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.RequestBenefitBean">

    <sql id="filter">
            <if test="firstName != null">
                AND r.`f_nam` LIKE CONCAT('%',#{firstName},'%')
            </if>
            <if test="middleName != null">
                AND r.`m_nam` LIKE CONCAT('%',#{middleName},'%')
            </if>
            <if test="lastName != null">
                AND r.`sur_nam` LIKE CONCAT('%',#{lastName},'%')
            </if>

            <if test="city != null">
                AND p.`city_id` IN (SELECT a.`object_id` FROM `city_attribute` a WHERE a.`attribute_type_id` = 400 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
                (SELECT sc.`id` FROM `city_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{city},'%')))
            </if>
            <if test="street != null">
                AND p.`street_id` IN (SELECT a.`object_id` FROM `street_attribute` a WHERE a.`attribute_type_id` = 300 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
                (SELECT sc.`id` FROM `street_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{street},'%')))
            </if>
            <if test="building != null">
                AND p.`building_id` IN (SELECT a.`object_id` FROM `building_attribute` a WHERE a.`attribute_type_id` = 500 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
                (SELECT sc.`id` FROM `building_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{building},'%')))
            </if>
            <if test="apartment != null">
                AND p.`apartment_id` IN (SELECT a.`object_id` FROM `apartment_attribute` a WHERE a.`attribute_type_id` = 100 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
                (SELECT sc.`id` FROM `apartment_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{apartment},'%')))
            </if>

            <if test="status != null">
                AND p.`status` = #{status}
            </if>
    </sql>

    <select id="count" resultType="int" parameterType="org.complitex.osznconnection.file.web.pages.benefit.RequestBenefitExample">
        SELECT COUNT(*) FROM `request_benefit` r
        JOIN `request_file` rf ON r.`request_file_id` = rf.`id`
        LEFT JOIN `request_payment` p ON r.`own_num_sr` = p.`own_num_sr`
        LEFT JOIN `request_file` pf ON p.`request_file_id` = pf.`id`
	WHERE rf.`organization_object_id` = pf.`organization_object_id` AND EXTRACT(YEAR_MONTH FROM rf.`date`) = EXTRACT(YEAR_MONTH FROM pf.`date`)
	AND r.`request_file_id` = #{fileId}
        <include refid="org.complitex.osznconnection.file.service.RequestBenefitBean.filter"/>
    </select>

    <select id="find" resultType="org.complitex.osznconnection.file.entity.RequestBenefit"
            parameterType="org.complitex.osznconnection.file.web.pages.benefit.RequestBenefitExample">
        SELECT DISTINCT r.`id`, r.`request_file_id` fileId, r.`f_nam` fNam, r.`m_nam` mNam, r.`sur_nam` surNam,
        p.`status` as status,
        (SELECT sc.`value` FROM `city_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `city_attribute` a WHERE a.`attribute_type_id` = 400 AND a.`status` = 'ACTIVE' AND a.`object_id` = p.`city_id`)) internalCity,
        (SELECT sc.`value` FROM `street_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `street_attribute` a WHERE a.`attribute_type_id` = 300 AND a.`status` = 'ACTIVE' AND a.`object_id` = p.`street_id`)) internalStreet,
        (SELECT sc.`value` FROM `building_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` =
        (SELECT a1.`value_id` FROM `building_attribute` a1
        JOIN `building_attribute` a2 ON (a1.`attribute_id` = a2.`attribute_id` AND a1.`object_id` = a2.`object_id`)
        WHERE a1.`attribute_type_id` = 500 AND a1.`status` = 'ACTIVE' AND
        a2.`attribute_type_id` = 503 AND a2.`status` = 'ACTIVE'
        AND a2.`value_id` = p.`street_id`
        AND a1.`object_id` = p.`building_id` AND a2.`object_id` = p.`building_id`
        )
        ) internalBuilding,
        (SELECT sc.`value` FROM `apartment_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `apartment_attribute` a WHERE a.`attribute_type_id` = 100 AND a.`status` = 'ACTIVE' AND a.`object_id` = p.`apartment_id`)) internalApartment
        FROM `request_benefit` r
        JOIN `request_file` rf ON r.`request_file_id` = rf.`id`
        LEFT JOIN `request_payment` p ON r.`own_num_sr` = p.`own_num_sr`
        LEFT JOIN `request_file` pf ON p.`request_file_id` = pf.`id`
	WHERE rf.`organization_object_id` = pf.`organization_object_id` AND EXTRACT(YEAR_MONTH FROM rf.`date`) = EXTRACT(YEAR_MONTH FROM pf.`date`)
	AND r.`request_file_id` = #{fileId}
        <include refid="org.complitex.osznconnection.file.service.RequestBenefitBean.filter"/>
        <if test="orderByClause != null">
            ORDER BY ${orderByClause}
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        <if test="size != 0">
            limit #{start},#{size}
        </if>
    </select>

</mapper>