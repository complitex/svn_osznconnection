<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.RequestPaymentBean">

    <resultMap id="requestPaymentResultMap" type="org.complitex.osznconnection.file.entity.RequestPayment">
        <id column="id" property="id"/>
        <result column="request_file_id" property="requestFileId"/>
        <result column="account_number" property="accountNumber"/>
        <result column="city_id" property="cityId"/>
        <result column="street_id" property="streetId"/>
        <result column="building_id" property="buildingId"/>
        <result column="apartment_id" property="apartmentId"/>
        <result column="status" property="status"/>

        <association property="dbfFields" javaType="map">
            <result column="OWN_NUM" property="OWN_NUM"/>
            <result column="REE_NUM" property="REE_NUM"/>
            <result column="OPP" property="OPP"/>
            <result column="NUMB" property="NUMB"/>
            <result column="MARK" property="MARK"/>
            <result column="CODE" property="CODE"/>
            <result column="ENT_COD" property="ENT_COD"/>
            <result column="FROG" property="FROG"/>
            <result column="FL_PAY" property="FL_PAY"/>
            <result column="NM_PAY" property="NM_PAY"/>
            <result column="DEBT" property="DEBT"/>
            <result column="CODE2_1" property="CODE2_1"/>
            <result column="CODE2_2" property="CODE2_2"/>
            <result column="CODE2_3" property="CODE2_3"/>
            <result column="CODE2_4" property="CODE2_4"/>
            <result column="CODE2_5" property="CODE2_5"/>
            <result column="CODE2_6" property="CODE2_6"/>
            <result column="CODE2_7" property="CODE2_7"/>
            <result column="CODE2_8" property="CODE2_8"/>
            <result column="NORM_F_1" property="NORM_F_1"/>
            <result column="NORM_F_2" property="NORM_F_2"/>
            <result column="NORM_F_3" property="NORM_F_3"/>
            <result column="NORM_F_4" property="NORM_F_4"/>
            <result column="NORM_F_5" property="NORM_F_5"/>
            <result column="NORM_F_6" property="NORM_F_6"/>
            <result column="NORM_F_7" property="NORM_F_7"/>
            <result column="NORM_F_8" property="NORM_F_8"/>
            <result column="OWN_NUM_SR" property="OWN_NUM_SR"/>
            <result column="DAT1" property="DAT1"/>
            <result column="DAT2" property="DAT2"/>
            <result column="OZN_PRZ" property="OZN_PRZ"/>
            <result column="DAT_F_1" property="DAT_F_1"/>
            <result column="DAT_F_2" property="DAT_F_2"/>
            <result column="DAT_FOP_1" property="DAT_FOP_1"/>
            <result column="DAT_FOP_2" property="DAT_FOP_2"/>
            <result column="ID_RAJ" property="ID_RAJ"/>
            <result column="SUR_NAM" property="SUR_NAM"/>
            <result column="F_NAM" property="F_NAM"/>
            <result column="M_NAM" property="M_NAM"/>
            <result column="IND_COD" property="IND_COD"/>
            <result column="INDX" property="INDX"/>
            <result column="N_NAME" property="N_NAME"/>
            <result column="VUL_NAME" property="VUL_NAME"/>
            <result column="BLD_NUM" property="BLD_NUM"/>
            <result column="CORP_NUM" property="CORP_NUM"/>
            <result column="FLAT" property="FLAT"/>
            <result column="CODE3_1" property="CODE3_1"/>
            <result column="CODE3_2" property="CODE3_2"/>
            <result column="CODE3_3" property="CODE3_3"/>
            <result column="CODE3_4" property="CODE3_4"/>
            <result column="CODE3_5" property="CODE3_5"/>
            <result column="CODE3_6" property="CODE3_6"/>
            <result column="CODE3_7" property="CODE3_7"/>
            <result column="CODE3_8" property="CODE3_8"/>
            <result column="OPP_SERV" property="OPP_SERV"/>
            <result column="RESERV1" property="RESERV1"/>
            <result column="RESERV2" property="RESERV2"/>
        </association>
    </resultMap>

    <resultMap id="internalRequestPaymentResultMap" type="org.complitex.osznconnection.file.entity.RequestPayment">
        <id property="id" column="id"/>
        <result column="requestFileId" property="requestFileId"/>
        <result column="status" property="status"/>
        <result column="internalCity" property="internalCity"/>
        <result column="internalStreet" property="internalStreet"/>
        <result column="internalBuilding" property="internalBuilding"/>
        <result column="internalApartment" property="internalApartment"/>
        <result column="city_id" property="cityId"/>
        <result column="street_id" property="streetId"/>
        <result column="building_id" property="buildingId"/>
        <result column="apartment_id" property="apartmentId"/>
        <result column="organizationId" property="organizationId"/>

        <association property="dbfFields" javaType="map">
            <result column="fNam" property="F_NAM"/>
            <result column="mNam" property="M_NAM"/>
            <result column="surNam" property="SUR_NAM"/>
            <result column="nName" property="N_NAME"/>
            <result column="vulName" property="VUL_NAME"/>
            <result column="bldNum" property="BLD_NUM"/>
            <result column="flat" property="FLAT"/>
        </association>

    </resultMap>

    <select id="selectRequestPayments" resultMap="requestPaymentResultMap">
        select * from `request_payment`
    </select>

    <insert id="insertRequestPayment" parameterType="org.complitex.osznconnection.file.entity.RequestPayment"
            keyProperty="id" useGeneratedKeys="true">
        insert into `request_payment`
            (`request_file_id`, `account_number`, `city_id`, `street_id`, `building_id`, `apartment_id`, `status`,
            <trim suffixOverrides=",">
                <foreach collection="dbfFields.keys" item="key">
                    `${key}`,
                </foreach>
            </trim>
            )
        values
            <trim suffixOverrides=",">
                (#{requestFileId}, #{accountNumber}, #{cityId}, #{streetId}, #{buildingId}, #{apartmentId}, #{status},
                <foreach collection="dbfFields.keys" item="key">
                    #{dbfFields.${key}},
                </foreach>
            </trim>
            )
    </insert>

    <update id="updateRequestPayment" parameterType="org.complitex.osznconnection.file.entity.RequestPayment">
        update `request_payment`
        <set>
            `request_file_id` = #{requestFileId}, `account_number` = #{accountNumber}, `city_id` = #{cityId},
            `street_id` = #{streetId}, `building_id` = #{buildingId}, `apartment_id` = #{apartmentId},
            `status` = #{status},
            <foreach collection="dbfFields.keys" item="key">
                `${key}` = #{dbfFields[key]}
            </foreach>
        </set>
        where
            `id` = #{id}
    </update>

    <sql id="filter">
        <if test="firstName != null">
            AND r.`F_NAM` LIKE CONCAT('%',#{firstName},'%')
        </if>
        <if test="middleName != null">
            AND r.`M_NAM` LIKE CONCAT('%',#{middleName},'%')
        </if>
        <if test="lastName != null">
            AND r.`SUR_NAM` LIKE CONCAT('%',#{lastName},'%')
        </if>

        <if test="city != null">
            AND r.`city_id` IN (SELECT a.`object_id` FROM `city_attribute` a WHERE a.`attribute_type_id` = 400 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
            (SELECT sc.`id` FROM `city_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{city},'%')))
        </if>
        <if test="street != null">
            AND r.`street_id` IN (SELECT a.`object_id` FROM `street_attribute` a WHERE a.`attribute_type_id` = 300 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
            (SELECT sc.`id` FROM `street_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{street},'%')))
        </if>
        <if test="building != null">
            AND r.`building_id` IN (SELECT a.`object_id` FROM `building_attribute` a WHERE a.`attribute_type_id` = 500 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
            (SELECT sc.`id` FROM `building_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{building},'%')))
        </if>
        <if test="apartment != null">
            AND r.`apartment_id` IN (SELECT a.`object_id` FROM `apartment_attribute` a WHERE a.`attribute_type_id` = 100 AND a.`status` = 'ACTIVE' AND a.`value_id` IN
            (SELECT sc.`id` FROM `apartment_string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`value` LIKE CONCAT('%',#{apartment},'%')))
        </if>

        <if test="status != null">
            AND r.`status` = #{status}
        </if>
    </sql>

    <select id="count" resultType="int" parameterType="org.complitex.osznconnection.file.web.pages.payment.RequestPaymentExample">
        SELECT COUNT(*) FROM `request_payment` r WHERE r.`request_file_id` = #{requestFileId}
        <include refid="org.complitex.osznconnection.file.service.RequestPaymentBean.filter"/>
    </select>

    <select id="find" parameterType="org.complitex.osznconnection.file.web.pages.payment.RequestPaymentExample"
            resultMap="internalRequestPaymentResultMap">
        SELECT r.`id`, r.`status`, r.`request_file_id` requestFileId, r.`F_NAM` fNam, r.`M_NAM` mNam, r.`SUR_NAM` surNam,
        (SELECT f.`organization_object_id` FROM `request_file` f WHERE f.`id` = r.`request_file_id`) organizationId,
        (SELECT sc.`value` FROM `city_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `city_attribute` a WHERE a.`attribute_type_id` = 400 AND a.`status` = 'ACTIVE' AND a.`object_id` = r.`city_id`)) internalCity,
        (SELECT sc.`value` FROM `street_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `street_attribute` a WHERE a.`attribute_type_id` = 300 AND a.`status` = 'ACTIVE' AND a.`object_id` = r.`street_id`)) internalStreet,
        (SELECT sc.`value` FROM `building_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` =
        (SELECT a1.`value_id` FROM `building_attribute` a1
        JOIN `building_attribute` a2 ON (a1.`attribute_id` = a2.`attribute_id` AND a1.`object_id` = a2.`object_id`)
        WHERE a1.`attribute_type_id` = 500 AND a1.`status` = 'ACTIVE' AND a1.`object_id` = r.`building_id` AND
        a2.`attribute_type_id` = 503 AND a2.`status` = 'ACTIVE' AND a2.`object_id` = r.`building_id`
        AND a2.`value_id` = r.`street_id`
        )
        ) internalBuilding,
        (SELECT sc.`value` FROM `apartment_string_culture` sc WHERE sc.`locale` = #{locale} AND
        sc.`id` = (SELECT a.`value_id` FROM `apartment_attribute` a WHERE a.`attribute_type_id` = 100 AND a.`status` = 'ACTIVE' AND a.`object_id` = r.`apartment_id`)) internalApartment
        FROM `request_payment` r WHERE r.`request_file_id` = #{requestFileId}
        <include refid="org.complitex.osznconnection.file.service.RequestPaymentBean.filter"/>
        <if test="orderByClause != null">
            ORDER BY ${orderByClause}
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        <if test="size != 0">
            limit #{start},#{size}
        </if>
    </select>

    <select id="findById" parameterType="long" resultMap="internalRequestPaymentResultMap">
        SELECT r.`id`, r.`status`, r.`request_file_id` requestFileId, r.`F_NAM` fNam, r.`M_NAM` mNam, r.`SUR_NAM` surNam,
        r.`N_NAME` nName, r.`VUL_NAME` vulName, r.`BLD_NUM` bldNum, r.`FLAT` flat,
        (SELECT f.`organization_object_id` FROM `request_file` f WHERE f.`id` = r.`request_file_id`) organizationId,
        r.`city_id`,
        r.`street_id`,
        r.`building_id`,
        r.`apartment_id`
        FROM `request_payment` r WHERE r.`id` = #{id}
    </select>

    <update id="update" parameterType="org.complitex.osznconnection.file.entity.RequestPayment">
        UPDATE `request_payment` SET `city_id` = #{cityId}, `street_id` = #{streetId}, `building_id` = #{buildingId}, `apartment_id` = #{apartmentId},
        `account_number` = #{accountNumber}, `status` = #{status} WHERE `id` = #{id}
    </update>

    <select id="findByFile" parameterType="org.complitex.osznconnection.file.web.pages.payment.RequestPaymentExample" resultMap="internalRequestPaymentResultMap">
        SELECT r.`id`, r.`status`, r.`request_file_id` requestFileId, r.`F_NAM` fNam, r.`M_NAM` mNam, r.`SUR_NAM` surNam,
        r.`N_NAME` nName, r.`VUL_NAME` vulName, r.`BLD_NUM` bldNum, r.`FLAT` flat,
        rf.`organization_object_id` organizationId
        FROM `request_payment` r
        JOIN `request_file` rf ON r.`request_file_id` = rf.`id`
        WHERE r.`request_file_id` = #{requestFileId} AND r.`status` != 'RESOLVED'
        LIMIT #{start},#{size}
    </select>

    <select id="countByFile" resultType="int" parameterType="long">
        SELECT COUNT(*) FROM `request_payment` r WHERE r.`request_file_id` = #{requestFileId} AND r.`status` != 'RESOLVED'
    </select>


</mapper>