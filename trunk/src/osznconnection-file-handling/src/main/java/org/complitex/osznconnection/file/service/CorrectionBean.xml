<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.CorrectionBean">

    <resultMap id="objectCorrection" type="org.complitex.osznconnection.file.entity.ObjectCorrection">
        <result column="id" property="id"/>
        <result column="internal_organization_id" property="internalOrganizationId"/>
        <result column="organization_id" property="organizationId"/>
        <result column="object_id" property="internalObjectId"/>
        <result column="parent_id" property="correctionParentId"/>
        <result column="correction" property="correction"/>
        <result column="organization_code" property="code"/>
        <result column="entity" property="entity"/>
        <result column="organization" property="organization"/>
        <result column="internalObject" property="internalObject"/>
        <result column="internalParentId" property="internalParentId"/>
        <result column="internalOrganization" property="internalOrganization"/>
    </resultMap>

    <resultMap id="entityTypeCorrection" extends="org.complitex.osznconnection.file.service.CorrectionBean.objectCorrection"
                type="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
    </resultMap>

    <insert id="insert" parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        INSERT INTO `${entity}_correction`
            (`organization_id`, `correction`, `object_id`, `organization_code`, `internal_organization_id`, `parent_id`)
         VALUES
            (#{organizationId}, #{correction}, #{internalObjectId}, #{code}, #{internalOrganizationId}, #{correctionParentId})
    </insert>

    <insert id="insertEntityType" parameterType="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
        INSERT INTO `entity_type_correction`(`organization_id`, `type`, `entity_type_id`, `organization_type_code`, `internal_organization_id`) VALUES
        (#{organizationId}, #{correction}, #{internalObjectId}, #{code}, #{internalOrganizationId})
    </insert>

    <sql id="filter">
        <where>
            <if test="internalObject != null">
                AND EXISTS(SELECT 1 FROM `${entity}_string_culture` sc WHERE sc.`value` LIKE CONCAT('%', #{internalObject}, '%') AND sc.`id` IN
                (SELECT a.`value_id` FROM `${entity}_attribute` a WHERE a.`object_id` = c.`object_id` AND a.`status` = 'ACTIVE' AND
                a.`attribute_type_id` = (SELECT eat.`id` FROM `entity_attribute_type` eat WHERE eat.`id` = (
                                            SELECT e.`id` FROM `entity` e WHERE e.`entity_table` = #{entity}))))
            </if>
            <if test="correction != null">
                AND c.`correction` LIKE CONCAT('%', #{correction}, '%')
            </if>
            <if test="code != null">
                AND c.`organization_code` LIKE CONCAT('%', #{code}, '%')
            </if>
            <if test="organization != null">
                AND EXISTS(SELECT 1 FROM `organization_string_culture` osc WHERE osc.`value` LIKE CONCAT('%', #{organization}, '%') AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = c.`organization_id` AND oa.`status` = 'ACTIVE' AND
                oa.`attribute_type_id` = 900))
            </if>
            <if test="internalOrganization != null">
                AND EXISTS(SELECT 1 FROM `organization_string_culture` osc WHERE osc.`value` LIKE CONCAT('%', #{internalOrganization}, '%') AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = c.`internal_organization_id` AND oa.`status` = 'ACTIVE' AND
                oa.`attribute_type_id` = 900))
            </if>
        </where>
    </sql>

    <select id="find" parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample"
            resultMap="org.complitex.osznconnection.file.service.CorrectionBean.objectCorrection">
        SELECT c.`id`,
        c.`correction`,
        c.`organization_code`,
        c.`organization_id`,
        IFNULL((SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = #{locale} AND osc.`id` IN
            (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`organization_id`
            AND oa.`attribute_type_id` = 900)),
        (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = (SELECT l.`locale` FROM `locales` l WHERE l.`system` = 1)
            AND osc.`id` IN (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`organization_id`
            AND oa.`attribute_type_id` = 900))
        ) organization,
        c.`internal_organization_id`,
        IFNULL((SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = #{locale} AND osc.`id` IN
            (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`internal_organization_id`
            AND oa.`attribute_type_id` = 900)),
        (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = (SELECT l.`locale` FROM `locales` l WHERE l.`system` = 1)
            AND osc.`id` IN (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`internal_organization_id`
            AND oa.`attribute_type_id` = 900))
        ) internalOrganization,
        c.`object_id`
        FROM `${entity}_correction` c
        <include refid="org.complitex.osznconnection.file.service.CorrectionBean.filter"/>
        <if test="orderByClause != null">
            ORDER BY ${orderByClause}
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        LIMIT #{start},#{size}
    </select>

     <select id="count" resultType="int" parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample">
        SELECT COUNT(*) FROM `${entity}_correction` c
        <include refid="org.complitex.osznconnection.file.service.CorrectionBean.filter"/>
    </select>

    <select id="findById" parameterType="hashmap"
                resultMap="org.complitex.osznconnection.file.service.CorrectionBean.objectCorrection">
        SELECT c.`id`,
        c.`correction`,
        c.`organization_code`,
        c.`organization_id`,
        c.`object_id`,
        c.`internal_organization_id`,
        c.`parent_id` correctionParentId
        FROM `${entity}_correction` c WHERE c.`id` = #{id}
    </select>

    <update id="update" parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        UPDATE `${entity}_correction` SET `organization_id` = #{organizationId}, `correction` = #{correction},
        `object_id` = #{internalObjectId}, `organization_code` = #{code}, `internal_organization_id` = #{internalOrganizationId},
        `parent_id` = #{correctionParentId}
        WHERE `id` = #{id}
    </update>

    <sql id="filterEntityTypes">
        <where>
            <if test="correction != null">
                AND etc.`type` LIKE CONCAT('%', #{correction}, '%')
            </if>
            <if test="code != null">
                AND etc.`organization_type_code` LIKE CONCAT('%', #{code}, '%')
            </if>
           <if test="organization != null">
                AND EXISTS(SELECT 1 FROM `organization_string_culture` osc WHERE osc.`value` LIKE CONCAT('%', #{organization}, '%') AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = etc.`organization_id` AND oa.`status` = 'ACTIVE' AND
                oa.`attribute_type_id` = 900))
            </if>
            <if test="internalObject != null">
                AND EXISTS(SELECT 1 FROM `string_culture` sc WHERE sc.`value` LIKE CONCAT('%', #{internalObject}, '%') AND sc.`id` IN
                (SELECT et.`entity_type_name_id` FROM `entity_type` et WHERE et.`id` = etc.`entity_type_id`))
            </if>
            <if test="internalOrganization != null">
                AND EXISTS(SELECT 1 FROM `organization_string_culture` osc WHERE osc.`value` LIKE CONCAT('%', #{internalOrganization}, '%') AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = etc.`internal_organization_id` AND oa.`status` = 'ACTIVE' AND
                oa.`attribute_type_id` = 900))
            </if>
        </where>
    </sql>

    <select id="findEntityTypes" resultMap="org.complitex.osznconnection.file.service.CorrectionBean.entityTypeCorrection"
            parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample">
        SELECT etc.`id`,
            etc.`type` correction,
            etc.`organization_type_code` organization_code,
            etc.`organization_id`,
            IFNULL((SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = #{locale} AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = etc.`organization_id`
                AND oa.`attribute_type_id` = 900)),
                (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = (SELECT l.`locale` FROM `locales` l WHERE l.`system` = 1)
                AND osc.`id` IN (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = etc.`organization_id`
                AND oa.`attribute_type_id` = 900))
            ) organization,
            etc.`internal_organization_id`,
            IFNULL((SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = #{locale} AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = etc.`internal_organization_id`
                AND oa.`attribute_type_id` = 900)),
            (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = (SELECT l.`locale` FROM `locales` l WHERE l.`system` = 1)
                AND osc.`id` IN (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = etc.`internal_organization_id`
                AND oa.`attribute_type_id` = 900))
            ) internalOrganization,
            etc.`entity_type_id` object_id,
            IFNULL((SELECT sc.`value` FROM `string_culture` sc WHERE sc.`locale` = #{locale} AND sc.`id` IN
                    (SELECT et.`entity_type_name_id` FROM `entity_type` et WHERE et.`id` = etc.`entity_type_id`)),
                   (SELECT sc.`value` FROM `string_culture` sc WHERE sc.`locale` = (SELECT l.`locale` FROM `locales` l WHERE l.`system` = 1)
                    AND sc.`id` IN (SELECT et.`entity_type_name_id` FROM `entity_type` et WHERE et.`id` = etc.`entity_type_id`))) internalObject
        FROM `entity_type_correction` etc
        <include refid="org.complitex.osznconnection.file.service.CorrectionBean.filterEntityTypes"/>
        <if test="orderByClause != null">
            ORDER BY ${orderByClause}
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        LIMIT #{start},#{size}
    </select>

    <select id="countEntityTypes" resultType="int" parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample">
        SELECT COUNT(*) FROM `entity_type_correction` etc
        <include refid="org.complitex.osznconnection.file.service.CorrectionBean.filterEntityTypes"/>
    </select>

    <select id="findEntityTypeById" parameterType="_long"
                resultMap="org.complitex.osznconnection.file.service.CorrectionBean.entityTypeCorrection">
        SELECT c.`id`,
        c.`type` correction,
        c.`organization_type_code` organization_code,
        c.`organization_id`,
        c.`entity_type_id` object_id,
        c.`internal_organization_id`
        FROM `entity_type_correction` c WHERE c.`id` = #{id}
    </select>

    <update id="updateEntityType" parameterType="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
        UPDATE `entity_type_correction` SET `organization_id` = #{organizationId}, `type` = #{correction}, `entity_type_id` = #{internalObjectId},
        `organization_type_code` = #{code}, `internal_organization_id` = #{internalOrganizationId}
        WHERE `id` = #{id}
    </update>

    <delete id="delete" parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        DELETE FROM `${entity}_correction` WHERE `id` = #{id}
    </delete>

    <delete id="deleteEntityType" parameterType="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
        DELETE FROM `entity_type_correction` WHERE `id` = #{id}
    </delete>

</mapper>