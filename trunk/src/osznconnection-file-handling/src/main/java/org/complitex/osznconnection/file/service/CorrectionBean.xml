<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.CorrectionBean">

    <resultMap id="correction" type="org.complitex.osznconnection.file.entity.Correction">
        <result column="id" property="id"/>
        <result column="parent_id" property="parentId"/>
        <result column="correction" property="correction"/>
        <result column="object_id" property="objectId"/>
        <result column="internal_organization_id" property="internalOrganizationId"/>
        <result column="internalOrganization" property="internalOrganization"/>
        <result column="organization_id" property="organizationId"/>
        <result column="organization_code" property="code"/>
        <result column="organization" property="organization"/>
    </resultMap>

    <insert id="insert" parameterType="org.complitex.osznconnection.file.entity.Correction"
            keyProperty="id" useGeneratedKeys="true">
        INSERT INTO `${entity}_correction`
            (`organization_id`, `correction`, `object_id`, `organization_code`, `internal_organization_id`, `parent_id`)
         VALUES
            (#{organizationId}, #{correction}, #{objectId}, #{code}, #{internalOrganizationId}, #{parentId})
    </insert>

    <sql id="filter">
        <where>
            <if test="internalObject != null">
                AND EXISTS(SELECT 1
                    FROM
                        `${entity}_string_culture` sc
                    WHERE
                        sc.`value` LIKE CONCAT('%', #{internalObject}, '%') AND sc.`id` IN (SELECT a.`value_id`
                        FROM `${entity}_attribute` a WHERE a.`object_id` = c.`object_id` AND a.`status` = 'ACTIVE' AND
                        a.`attribute_type_id` = (SELECT eat.`id` FROM `entity_attribute_type` eat
                        WHERE eat.`id` = (SELECT e.`id` FROM `entity` e WHERE e.`entity_table` = #{entity}))))
            </if>
            <if test="correction != null">
                AND c.`correction` LIKE CONCAT('%', #{correction}, '%')
            </if>
            <if test="code != null">
                AND c.`organization_code` LIKE CONCAT('%', #{code}, '%')
            </if>
            <if test="organization != null">
                AND EXISTS(SELECT 1
                    FROM
                        `organization_string_culture` osc
                    WHERE
                        osc.`value` LIKE CONCAT('%', #{organization}, '%') AND osc.`id` IN
                        (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = c.`organization_id`
                        AND oa.`status` = 'ACTIVE' AND oa.`attribute_type_id` = 900))
            </if>
            <if test="internalOrganization != null">
                AND EXISTS(SELECT 1
                    FROM
                        `organization_string_culture` osc
                    WHERE
                        osc.`value` LIKE CONCAT('%', #{internalOrganization}, '%') AND osc.`id` IN
                        (SELECT oa.`value_id` FROM `organization_attribute` oa
                        WHERE oa.`object_id` = c.`internal_organization_id` AND oa.`status` = 'ACTIVE'
                        AND oa.`attribute_type_id` = 900))
            </if>
        </where>
    </sql>

    <select id="find" parameterType="org.complitex.osznconnection.file.entity.example.CorrectionExample"
            resultMap="correction">
        SELECT
            distinct c.*,
        IFNULL(
            (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale_id` = #{localeId} AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE'
                AND oa.`object_id` = c.`organization_id` AND oa.`attribute_type_id` = 900)),
            (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale_id` = (SELECT l.`id`
                FROM `locales` l WHERE l.`system` = 1) AND osc.`id` IN (SELECT oa.`value_id`
                FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`organization_id`
                AND oa.`attribute_type_id` = 900))
        ) organization,
        IFNULL(
            (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale_id` = #{localeId} AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE'
                AND oa.`object_id` = c.`internal_organization_id` AND oa.`attribute_type_id` = 900)),
            (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale_id` = (SELECT l.`id`
                FROM `locales` l WHERE l.`system` = 1) AND osc.`id` IN (SELECT oa.`value_id`
                FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE'
                AND oa.`object_id` = c.`internal_organization_id` AND oa.`attribute_type_id` = 900))
        ) internalOrganization

        FROM `${entity}_correction` c

        <if test="orderByClause == 'object'">
            left join `${entity}_attribute` ea on (ea.`object_id` = c.`object_id`)
            left join `${entity}_string_culture` esc on (esc.`id` = ea.`value_id` and esc.`locale_id` = #{localeId})

            <if test="parentEntity != null">
                left join `${entity}` e on (e.`object_id` = c.`object_id`)
                left join `${parentEntity}_attribute` pa on (pa.`object_id` = e.`parent_id`)
                left join `${parentEntity}_string_culture` psc on (psc.`id` = pa.`value_id` and psc.`locale_id` = #{localeId})
            </if>
        </if>

        <if test="orderByClause == 'correction' and parentEntity != null">
            left join `${entity}_correction` ec on (ec.`id` = c.`parent_id`)
        </if>

        <include refid="filter"/>

        <if test="orderByClause != null">
            ORDER BY
            <choose>
                <when test="orderByClause == 'object'">
                    <if test="parentEntity != null">
                        psc.`value` <include refid="asc"/>,
                    </if>
                    esc.`value`
                </when>
                <when test="orderByClause == 'correction'">
                    <if test="parentEntity != null">
                        ec.`correction` <include refid="asc"/>,
                    </if>
                    c.`correction`
                </when>
                <otherwise>
                    ${orderByClause}
                </otherwise>
            </choose>

            <include refid="asc"/>
        </if>

        LIMIT #{start},#{size}
    </select>

    <sql id="asc">
        <choose><when test="asc">ASC</when><otherwise>DESC</otherwise></choose>
    </sql>

    <select id="count" resultType="int" parameterType="org.complitex.osznconnection.file.entity.example.CorrectionExample">
        SELECT COUNT(*) FROM `${entity}_correction` c
        <include refid="org.complitex.osznconnection.file.service.CorrectionBean.filter"/>
    </select>

    <select id="findById" parameterType="hashmap"
                resultMap="org.complitex.osznconnection.file.service.CorrectionBean.correction">
        SELECT * FROM `${entity}_correction` c WHERE c.`id` = #{id}
    </select>

    <update id="update" parameterType="org.complitex.osznconnection.file.entity.Correction">
        UPDATE `${entity}_correction` SET `organization_id` = #{organizationId}, `correction` = #{correction},
        `object_id` = #{objectId}, `organization_code` = #{code}, `internal_organization_id` = #{internalOrganizationId},
        `parent_id` = #{parentId}
        WHERE `id` = #{id}
    </update>

    <delete id="delete" parameterType="org.complitex.osznconnection.file.entity.Correction">
        DELETE FROM `${entity}_correction` WHERE `id` = #{id}
    </delete>

</mapper>