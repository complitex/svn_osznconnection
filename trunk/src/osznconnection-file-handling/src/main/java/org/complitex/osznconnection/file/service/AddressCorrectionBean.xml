<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.AddressCorrectionBean">

    <resultMap id="objectCorrection" type="org.complitex.osznconnection.file.entity.ObjectCorrection">
        <result column="entity" property="entity"/>
        <result column="correction" property="correction"/>
        <result column="organization_code" property="code"/>
        <result column="organization_id" property="organizationId"/>
        <result column="organization" property="organization"/>
        <result column="internalObjectId" property="internalObjectId"/>
        <result column="internalObject" property="internalObject"/>
        <result column="internalParentId" property="internalParentId"/>
    </resultMap>

    <resultMap id="buildingCorrection" type="org.complitex.osznconnection.file.entity.BuildingCorrection" extends="objectCorrection">
        <result column="correction_corp" property="correctionCorp"/>
    </resultMap>

    <resultMap id="entityTypeCorrection" type="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
        <result column="type" property="type"/>
        <result column="code" property="code"/>
        <result column="organizationId" property="organizationId"/>
        <result column="internalEntityTypeId" property="internalEntityTypeId"/>
    </resultMap>

    <select id="findInternalObject" resultType="long" parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        SELECT c.`object_id` FROM `${entity}_correction` c WHERE c.`organization_id` = #{organizationId} AND
        TO_CYRILLIC(c.`correction`) = TO_CYRILLIC(#{correction})
        <if test="internalParentId != null">
            AND EXISTS(SELECT 1 FROM `${entity}` e WHERE e.`id` = c.`object_id` AND e.`status` = 'ACTIVE' AND e.`parent_id` = #{internalParentId})
        </if>
        LIMIT 0,1
    </select>

    <select id="findInternalBuilding" resultType="long" parameterType="org.complitex.osznconnection.file.entity.BuildingCorrection">
        SELECT c.`object_id` FROM `building_correction` c WHERE c.`organization_id` = #{organizationId} AND
        TO_CYRILLIC(c.`correction`) = TO_CYRILLIC(#{correction})
        <choose>
            <when test="correctionCorp == null">
                AND c.`correction_corp` IS NULL
            </when>
            <otherwise>
                AND TO_CYRILLIC(c.`correction_corp`) = TO_CYRILLIC(#{correctionCorp})
            </otherwise>
        </choose>
        <if test="internalParentId != null">
            AND EXISTS(SELECT 1 FROM `building` e WHERE e.`id` = c.`object_id` AND e.`status` = 'ACTIVE' AND e.`parent_id` = #{internalParentId})
        </if>
        LIMIT 0,1
    </select>

    <select id="findInternalObjectType" resultType="long" parameterType="long">
        SELECT etc.`entity_type_id` typeId
        FROM `entity_type_correction` etc
        WHERE etc.`organization_id` = #{organizationId}
        AND EXISTS(SELECT 1 FROM `entity_type` et WHERE et.`id` = etc.`entity_type_id` AND et.`end_date` IS NULL)
        LIMIT 0,1
    </select>

    <insert id="insert" parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        INSERT INTO `${entity}_correction`(`organization_id`, `correction`, `object_id`) VALUES
        (#{organizationId}, UPPER(TO_CYRILLIC(#{correction})), #{internalObjectId})
    </insert>

    <insert id="insertBuilding" parameterType="org.complitex.osznconnection.file.entity.BuildingCorrection">
        INSERT INTO `building_correction`(`organization_id`, `correction`, `correction_corp`, `object_id`) VALUES
        (#{organizationId}, UPPER(TO_CYRILLIC(#{correction})), UPPER(TO_CYRILLIC(#{correctionCorp})), #{internalObjectId})
    </insert>

    <select id="findOutgoingObject" resultMap="org.complitex.osznconnection.file.service.AddressCorrectionBean.objectCorrection"
            parameterType="org.complitex.osznconnection.file.entity.ObjectCorrection">
        SELECT c.`correction`, c.`organization_code` FROM `${entity}_correction` c
        WHERE c.`organization_id` = #{organizationId}
        AND c.`object_id` = #{internalObjectId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingBuilding" resultMap="org.complitex.osznconnection.file.service.AddressCorrectionBean.buildingCorrection"
            parameterType="org.complitex.osznconnection.file.entity.BuildingCorrection">
        SELECT c.`correction`, c.`correction_corp`, c.`organization_code` FROM `building_correction` c
        WHERE c.`organization_id` = #{organizationId}
        AND c.`object_id` = #{internalObjectId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingObjectType" resultMap="org.complitex.osznconnection.file.service.AddressCorrectionBean.entityTypeCorrection"
            parameterType="org.complitex.osznconnection.file.entity.EntityTypeCorrection">
        SELECT etc.`type` type, etc.`organization_type_code` code
        FROM `entity_type_correction` etc
        WHERE etc.`organization_id` = #{organizationId}
        AND etc.`entity_type_id` = #{internalEntityTypeId}
        LIMIT 0,1
    </select>

    <select id="findOutgoingDistrict" resultMap="org.complitex.osznconnection.file.service.AddressCorrectionBean.objectCorrection"
            parameterType="long">
        SELECT c.`correction`, c.`organization_code` FROM `district_correction` c
        WHERE c.`organization_id` = #{organizationId}
        AND c.`object_id` = (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE
                oa.`status` = 'ACTIVE' AND oa.`object_id` = #{organizationId} AND oa.`attribute_type_id` = 902)
        LIMIT 0,1
    </select>

    <sql id="filter">
        <where>
            <if test="internalObject != null">
                AND EXISTS(SELECT 1 FROM `${entity}_string_culture` sc WHERE sc.`value` LIKE CONCAT('%', #{internalObject}, '%') AND sc.`id` IN
                (SELECT a.`value_id` FROM `${entity}_attribute` a WHERE a.`object_id` = c.`object_id` AND a.`status` = 'ACTIVE' AND
                a.`attribute_type_id` = (SELECT eat.`id` FROM `entity_attribute_type` eat WHERE eat.`id` = (
                                            SELECT e.`id` FROM `entity` e WHERE e.`entity_table` = #{entity}))))
            </if>
            <if test="correction != null">
                AND c.`correction` LIKE CONCAT('%', #{correction}, '%')
            </if>
            <if test="code != null">
                AND c.`organization_code` = #{code}
            </if>
            <if test="organization != null">
                AND EXISTS(SELECT 1 FROM `organization_string_culture` osc WHERE osc.`value` LIKE CONCAT('%', #{organization}, '%') AND osc.`id` IN
                (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`object_id` = c.`organization_id` AND oa.`status` = 'ACTIVE' AND
                oa.`attribute_type_id` = 900))
            </if>
        </where>
    </sql>

    <select id="find" parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample"
            resultMap="org.complitex.osznconnection.file.service.AddressCorrectionBean.objectCorrection">
        SELECT c.`correction`,
        c.`organization_code`,
        c.`organization_id`,
        (SELECT osc.`value` FROM `organization_string_culture` osc WHERE osc.`locale` = #{locale} AND osc.`id` IN
        (SELECT oa.`value_id` FROM `organization_attribute` oa WHERE oa.`status` = 'ACTIVE' AND oa.`object_id` = c.`organization_id`
        AND oa.`attribute_type_id` = 900)) organization,
        c.`object_id` internalObjectId
        FROM `${entity}_correction` c
        <include refid="org.complitex.osznconnection.file.service.AddressCorrectionBean.filter"/>
        <if test="orderByClause != null">
            ORDER BY ${orderByClause}
            <choose>
                <when test="asc">
                    ASC
                </when>
                <otherwise>
                    DESC
                </otherwise>
            </choose>
        </if>
        LIMIT #{start},#{size}
    </select>

     <select id="count" resultType="int" parameterType="org.complitex.osznconnection.file.entity.example.ObjectCorrectionExample">
        SELECT COUNT(*) FROM `${entity}_correction` c
        <include refid="org.complitex.osznconnection.file.service.AddressCorrectionBean.filter"/>
    </select>

</mapper>