<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.osznconnection.file.service.StatusDetailBean">
    <resultMap id="statusDetailResultMap" type="org.complitex.osznconnection.file.entity.StatusDetail">
        <id column="status" property="requestStatus"/>
        <result column="count" property="count"/>
        <result column="account" property="account"/>
        <result column="city" property="city"/>
        <result column="street" property="street"/>
        <result column="building" property="building"/>
        <result column="corp" property="corp"/>
    </resultMap>

    <resultMap id="rootStatusDetailResultMap" type="org.complitex.osznconnection.file.entity.StatusDetail">
        <id column="status" property="requestStatus"/>
        <result column="count" property="count"/>

        <collection property="statusDetails" column="status=status,id=request_file_id"
                    ofType="org.complitex.osznconnection.file.entity.StatusDetail"
                    select="selectPaymentStatusDetail"/>
    </resultMap>

    <select id="selectPaymentRootStatusDetail" parameterType="org.complitex.osznconnection.file.entity.RequestFile"
            resultMap="rootStatusDetailResultMap">
        select count(*) `count`, `status`, `request_file_id` from `payment` where `request_file_id` = #{id}
            group by `status` order by `count` desc
    </select>

    <select id="selectPaymentStatusDetail" parameterType="map" resultMap="statusDetailResultMap">
        <choose>
            <!--account number -->
            <when test="status == 212 or status == 213 or status == 217">
                select count(*) as `count`, `OWN_NUM_SR` as `account`, `status` from `payment`
                    where `request_file_id` = #{id} and `status` = #{status} group by `OWN_NUM_SR`
            </when>

            <!--city-->
            <when test="status == 200 or status == 205">
                select count(*) as `count`, `N_NAME` as `city`, `status` from `payment`
                    where `request_file_id` = #{id} and `status` = #{status} group by `N_NAME`
            </when>

            <!--street-->
            <when test="status == 201 or status == 208">
                select count(*) `count`, `N_NAME` as `city`, `VUL_NAME` as `street`, `status`
                    from `payment` where `request_file_id` = #{id} and `status` = #{status} group by `N_NAME`, `VUL_NAME`
            </when>

            <!--building-->
            <when test="status == 202 or status == 209">
                select count(*) `count`, `N_NAME` as `city`, `VUL_NAME` as `street`, `BLD_NUM` as `building`,
                    `status` from `payment` where `request_file_id` = #{id} and `status` = #{status}
                    group by `N_NAME`, `VUL_NAME`, `BLD_NUM`
            </when>

            <!--building corp-->
            <when test="status == 210">
                select count(*) `count`, `N_NAME` as `city`, `VUL_NAME` as `street`, `BLD_NUM` as `building`,
                    `CORP_NUM` as `corp`, `status` from `payment` where `request_file_id` = #{id}
                    and `status` = #{status} group by `N_NAME`, `VUL_NAME`, `BLD_NUM`, `CORP_NUM`
            </when>
            <otherwise>
                select 0 as `count` from `payment` where 1 > 1;
            </otherwise>
        </choose>
    </select>
</mapper>