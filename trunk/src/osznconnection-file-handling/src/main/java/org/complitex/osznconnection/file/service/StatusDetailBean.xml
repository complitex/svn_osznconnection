<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.osznconnection.file.service.StatusDetailBean">
    <resultMap id="statusDetailResultMap" type="org.complitex.osznconnection.file.entity.StatusDetail">
        <id column="status" property="requestStatus"/>
        <result column="name" property="name"/>
        <result column="count" property="count"/>
    </resultMap>

    <resultMap id="rootStatusDetailResultMap" type="org.complitex.osznconnection.file.entity.StatusDetail"
               extends="statusDetailResultMap">
        <collection property="statusDetails" column="status=status,id=request_file_id"
                    ofType="org.complitex.osznconnection.file.entity.StatusDetail"
                    select="selectPaymentStatusDetail"/>
    </resultMap>

    <select id="selectPaymentRootStatusDetail" parameterType="org.complitex.osznconnection.file.entity.RequestFile"
            resultMap="rootStatusDetailResultMap">
        select count(*) `count`, `status`, `request_file_id` from `payment` where `request_file_id` = #{id} group by `status`
    </select>

    <select id="selectPaymentStatusDetail" parameterType="map" resultMap="statusDetailResultMap">
        <choose>
            <!--account number -->
            <when test="status == 212 or status == 213 or status == 217">
                select count(*) `count`, `OWN_NUM_SR` `name`, `status` `request_status` from `payment`
                    where `request_file_id` = #{id} and `status` = #{status} group by `OWN_NUM_SR`
            </when>

            <!--city-->
            <when test="status == 200 or status == 205">
                select count(*) `count`, `N_NAME` `name`, `status` `request_status` from `payment`
                    where `request_file_id` = #{id} and `status` = #{status} group by `N_NAME`
            </when>

            <!--street-->
            <when test="status == 201 or status == 207">
                select count(*) `count`, CONCAT(`N_NAME`, ', ', `VUL_NAME`) `name`, `status` `request_status`
                    from `payment` where `request_file_id` = #{id} and `status` = #{status} group by `N_NAME`, `VUL_NAME`
            </when>

            <!--building-->
            <when test="status == 202 or status == 209">
                select count(*) `count`, CONCAT(`N_NAME`, ', ', `VUL_NAME`, ', ', `BLD_NUM`) `name`,
                    `status` `request_status` from `payment` where `request_file_id` = #{id} and `status` = #{status}
                    group by `N_NAME`, `VUL_NAME`, `BLD_NUM`
            </when>

            <!--building corp-->
            <when test="status == 210">
                select count(*) `count`, CONCAT(`N_NAME`, ', ', `VUL_NAME`, ', ', `BLD_NUM`, ', ', `CORP_NUM`) `name`,
                    `status` `request_status` from `payment` where `request_file_id` = #{id} and `status` = #{status}
                    group by `N_NAME`, `VUL_NAME`, `BLD_NUM`, `CORP_NUM`
            </when>
            <otherwise>
                select 0 `count`, 0 `name`, 0 `request_status` from `payment` where 1 > 1;
            </otherwise>
        </choose>
    </select>
</mapper>