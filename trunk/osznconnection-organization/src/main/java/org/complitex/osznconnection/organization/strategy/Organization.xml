<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.complitex.osznconnection.organization.strategy.Organization">

    <select id="find" resultMap="org.complitex.dictionary.entity.DomainObject.DomainObject" parameterType="DomainObjectExample">
        SELECT e.* FROM `organization` e WHERE
        <include refid="org.complitex.dictionary.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.permissionFilter"/>
        <include refid="org.complitex.osznconnection.organization.strategy.Organization.filter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.orderBy"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.limit"/>
    </select>

    <sql id="filter">
        <if test="id != null">
            AND e.`object_id` = #{id}
        </if>
        <foreach item="attrExample" collection="attributeExamples">
            <choose>
                <when test="attrExample.attributeTypeId == 903">
                    AND EXISTS(SELECT 1 FROM `organization_attribute` parent_attr WHERE parent_attr.`object_id` = e.`object_id`
                            AND parent_attr.`status` = 'ACTIVE' AND parent_attr.`attribute_type_id` = #{attrExample.attributeTypeId}
                            AND parent_attr.`value_id` = #{attrExample.value})
                </when>
                <otherwise>
                    <if test="attrExample.value != null">
                        AND EXISTS(SELECT 1 FROM `organization_attribute` attr WHERE attr.`object_id` = e.`object_id`
                            AND attr.`status` = 'ACTIVE' AND attr.`attribute_type_id` = #{attrExample.attributeTypeId}
                            AND attr.`value_id` IN (SELECT sc.`id` FROM `${table}_string_culture` sc WHERE sc.`value`
                                <choose>
                                    <when test="comparisonType == 'LIKE'">
                                        LIKE '%${attrExample.value}%'
                                    </when>
                                    <when test="comparisonType == 'EQUALITY'">
                                        = #{attrExample.value}
                                    </when>
                                </choose>
                            )
                        )
                    </if>
                </otherwise>
            </choose>
        </foreach>
        <if test="parentId != null and parentEntity != null">
            AND e.`parent_entity_id` = (SELECT ent.`id` FROM `entity` ent WHERE ent.`entity_table` = #{parentEntity}) AND e.`parent_id` = #{parentId}
        </if>
        <if test="entityTypeId != null">
            AND e.`entity_type_id` = #{entityTypeId}
        </if>
    </sql>

    <select id="count" resultType="integer" parameterType="DomainObjectExample">
        SELECT COUNT(*) FROM `organization` e WHERE
        <include refid="org.complitex.dictionary.entity.DomainObject.statusFilter"/>
        <include refid="org.complitex.dictionary.entity.DomainObject.permissionFilter"/>
        <include refid="org.complitex.osznconnection.organization.strategy.Organization.filter"/>
    </select>

    <!-- Validation -->

    <select id="validateCode" resultType="long" parameterType="map">
        SELECT DISTINCT o.`object_id` FROM `organization` o
                                    JOIN `organization_attribute` a ON (o.`object_id` = a.`object_id` AND a.`status` = 'ACTIVE')
                                    JOIN `organization_string_culture` sc ON (a.`value_id` = sc.`id`)
            WHERE (o.`status` IN ('ACTIVE', 'INACTIVE'))
            AND sc.`locale_id` = (SELECT l.`id` FROM `locales` l WHERE l.`system` = 1) AND a.`attribute_type_id` = 901
            AND sc.`value` = #{code}
            <choose>
                <when test="parentEntityId != null and parentId != null">
                    AND o.`parent_entity_id` = #{parentEntityId} AND o.`parent_id` = #{parentId}
                </when>
                <otherwise>
                    AND o.`parent_entity_id` IS NULL AND o.`parent_id` IS NULL
                </otherwise>
            </choose>
    </select>

    <select id="validateName" resultType="long" parameterType="map">
        SELECT DISTINCT o.`object_id` FROM `organization` o
                                    JOIN `organization_attribute` a ON (o.`object_id` = a.`object_id` AND a.`status` = 'ACTIVE')
                                    JOIN `organization_string_culture` sc ON (a.`value_id` = sc.`id`)
            WHERE (o.`status` IN ('ACTIVE', 'INACTIVE'))
            AND sc.`locale_id` = #{localeId} AND a.`attribute_type_id` = 900
            AND sc.`value` = #{name}
            <choose>
                <when test="parentEntityId != null and parentId != null">
                    AND o.`parent_entity_id` = #{parentEntityId} AND o.`parent_id` = #{parentId}
                </when>
                <otherwise>
                    AND o.`parent_entity_id` IS NULL AND o.`parent_id` IS NULL
                </otherwise>
            </choose>
    </select>

</mapper>
